<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ooosh Tours - Payment Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(59, 130, 246, 0.3);
      border-radius: 50%;
      border-top-color: #3b82f6;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .payment-option {
      transition: all 0.2s ease;
    }
    .payment-option:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .payment-option.selected {
      border-color: #3b82f6;
      background-color: #eff6ff;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="container mx-auto px-4 py-8 max-w-2xl">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">Ooosh Tours</h1>
      <p class="text-gray-600">Secure Payment Portal</p>
    </div>
    
    <!-- Loading State -->
    <div id="loading" class="bg-white rounded-lg shadow-md p-8 text-center">
      <div class="loading mx-auto mb-4"></div>
      <p class="text-gray-600">Loading your booking details...</p>
    </div>
    
    <!-- Security Redirect State -->
    <div id="security-redirect" class="hidden bg-white rounded-lg shadow-md p-8 text-center">
      <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4">
        <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
      </div>
      <h2 class="text-xl font-bold text-gray-900 mb-2">Securing Your Connection</h2>
      <p class="text-gray-600 mb-4">For your security, we're creating a secure link to your booking...</p>
      <div class="loading mx-auto"></div>
    </div>
    
    <!-- Error State -->
    <div id="error" class="hidden bg-white rounded-lg shadow-md p-8">
      <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6">
        <div class="flex">
          <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
            </svg>
          </div>
          <div class="ml-3">
            <p class="text-sm text-red-700" id="error-message">Unable to load booking details.</p>
          </div>
        </div>
      </div>
      <button onclick="window.location.reload()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition-colors">
        Try Again
      </button>
    </div>
    
    <!-- Main Payment Interface -->
    <div id="payment-interface" class="hidden">
      <!-- Job Details Card -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Booking Details</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
          <div>
            <p class="text-gray-600">Job ID</p>
            <p class="font-medium" id="job-id"></p>
          </div>
          <div>
            <p class="text-gray-600">Customer</p>
            <p class="font-medium" id="customer-name"></p>
          </div>
          <div>
            <p class="text-gray-600">Hire Period</p>
            <p class="font-medium" id="hire-period"></p>
          </div>
          <div>
            <p class="text-gray-600">Status</p>
            <p class="font-medium" id="job-status"></p>
          </div>
        </div>
      </div>
      
      <!-- Financial Summary -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Payment Summary</h2>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-gray-600">Total Hire Value (inc VAT)</span>
            <span class="font-medium">¬£<span id="total-value"></span></span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Amount Already Paid</span>
            <span class="font-medium text-green-600">¬£<span id="amount-paid"></span></span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Insurance Excess Paid</span>
            <span class="font-medium text-green-600">¬£<span id="excess-paid"></span></span>
          </div>
          <hr class="my-2">
          <div class="flex justify-between text-lg font-semibold">
            <span>Remaining Balance</span>
            <span id="remaining-balance-container">
              <span class="text-red-600" id="remaining-balance-positive">¬£<span id="remaining-balance"></span></span>
              <span class="text-green-600 hidden" id="remaining-balance-negative">-¬£<span id="overpaid-amount"></span> (Overpaid)</span>
            </span>
          </div>
        </div>
        
        <!-- Payment History Toggle -->
        <div class="mt-4 pt-4 border-t border-gray-200">
          <button id="toggle-payment-history" class="flex items-center text-sm text-blue-600 hover:text-blue-800 transition-colors">
            <svg id="history-arrow" class="w-4 h-4 mr-2 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
            <span>View Payment History</span>
          </button>
          
          <!-- Payment History Details -->
          <div id="payment-history" class="hidden mt-3 space-y-2">
            <div class="bg-gray-50 rounded p-3">
              <h4 class="font-medium text-sm text-gray-900 mb-2">Hire Payments</h4>
              <div id="hire-payments-list" class="space-y-1 text-xs text-gray-600">
                <!-- Populated by JavaScript -->
              </div>
            </div>
            
            <div class="bg-gray-50 rounded p-3" id="excess-payments-section">
              <h4 class="font-medium text-sm text-gray-900 mb-2">Excess Payments</h4>
              <div id="excess-payments-list" class="space-y-1 text-xs text-gray-600">
                <!-- Populated by JavaScript -->
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Payment Options -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Payment Methods</h2>
        
        <!-- Payment Method Tabs -->
        <div class="border-b border-gray-200 mb-6">
          <nav class="-mb-px flex space-x-8">
            <button id="tab-card" class="tab-button active py-2 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600">
              üí≥ Card Payment
            </button>
            <button id="tab-bank" class="tab-button py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
              üè¶ Bank Transfer
            </button>
            <button id="tab-paypal" class="tab-button py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
              üí∞ PayPal
            </button>
          </nav>
        </div>
        
        <!-- Card Payment Tab -->
        <div id="content-card" class="tab-content">
          <div class="space-y-4" id="payment-options">
            <!-- Options will be populated by JavaScript -->
          </div>
          
          <!-- Total to Pay -->
          <div id="payment-total-section" class="hidden mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
            <div class="flex justify-between items-center">
              <span class="text-lg font-semibold text-gray-900">Total to Pay:</span>
              <span class="text-2xl font-bold text-blue-600">¬£<span id="payment-total">0.00</span></span>
            </div>
            <p class="text-sm text-gray-600 mt-2" id="payment-description"></p>
          </div>
          
          <button id="pay-button" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white font-medium py-3 px-6 rounded-md transition-colors" disabled>
            <span id="pay-button-text">Select Payment Options</span>
            <div id="pay-button-loading" class="hidden loading ml-2"></div>
          </button>
          <p class="text-xs text-gray-500 text-center mt-2">Secure payment processed by Stripe</p>
        </div>
        
        <!-- Bank Transfer Tab -->
        <div id="content-bank" class="tab-content hidden">
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
            <h3 class="font-medium text-blue-900 mb-2">üè¶ Bank Transfer Instructions</h3>
            <p class="text-sm text-blue-800">Transfer directly to our account - no fees, but takes 1-2 business days to process.</p>
          </div>
          
          <div class="bg-white border border-gray-200 rounded-lg p-4 space-y-3">
            <div class="flex justify-between">
              <span class="text-sm font-medium text-gray-600">Bank:</span>
              <span class="text-sm text-gray-900">Wise</span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm font-medium text-gray-600">Account Name:</span>
              <span class="text-sm text-gray-900">Ooosh! Tours Ltd</span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm font-medium text-gray-600">Sort Code:</span>
              <span class="text-sm text-gray-900 font-mono">23-08-01</span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm font-medium text-gray-600">Account Number:</span>
              <span class="text-sm text-gray-900 font-mono">98983265</span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm font-medium text-gray-600">IBAN:</span>
              <span class="text-sm text-gray-900 font-mono">GB63 TRWI 2308 0198 9832 65</span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm font-medium text-gray-600">SWIFT/BIC:</span>
              <span class="text-sm text-gray-900 font-mono">TRWIGB2L</span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm font-medium text-gray-600">Reference:</span>
              <span class="text-sm text-gray-900 font-mono font-bold">Job <span id="bank-job-id"></span></span>
            </div>
          </div>
          
          <div class="mt-4 p-4 bg-red-50 border border-red-200 rounded text-sm text-red-800">
            <strong>üö® IMPORTANT:</strong> You must include your job number (<strong>Job <span id="bank-job-id-2"></span></strong>) with any payments! Failure to include your job number may result in your booking being lost or delayed.
          </div>
        </div>
        
        <!-- PayPal Tab -->
        <div id="content-paypal" class="tab-content hidden">
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
            <h3 class="font-medium text-blue-900 mb-2">üí∞ PayPal Payment</h3>
            <p class="text-sm text-blue-800">Send payment as Friends & Family to avoid fees - usually processes instantly.</p>
          </div>
          
          <div class="bg-white border border-gray-200 rounded-lg p-4 space-y-3">
            <div class="flex justify-between">
              <span class="text-sm font-medium text-gray-600">PayPal Email:</span>
              <span class="text-sm text-gray-900">info@oooshtours.co.uk</span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm font-medium text-gray-600">Payment Type:</span>
              <span class="text-sm text-gray-900">Friends & Family</span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm font-medium text-gray-600">Reference:</span>
              <span class="text-sm text-gray-900 font-mono font-bold">Job <span id="paypal-job-id"></span></span>
            </div>
          </div>
          
          <a href="https://paypal.me/oooshtours" target="_blank" class="block w-full mt-4 bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-3 px-6 rounded-md transition-colors text-center">
            Open PayPal ‚Üí
          </a>
          
          <div class="mt-4 p-4 bg-red-50 border border-red-200 rounded text-sm text-red-800">
            <strong>üö® IMPORTANT:</strong> You must include your job number (<strong>Job <span id="paypal-job-id-2"></span></strong>) in the payment note! Failure to include your job number may result in your booking being lost or delayed.
          </div>
        </div>
      </div>
    </div>
    
    <!-- Success State -->
    <div id="success" class="hidden bg-white rounded-lg shadow-md p-8 text-center">
      <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
        <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
      </div>
      <h2 class="text-2xl font-bold text-gray-900 mb-2">Payment Successful!</h2>
      <p class="text-gray-600 mb-6">Thank you for your payment. Your booking details have been updated.</p>
      <div class="bg-gray-50 rounded-lg p-4 text-left mb-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
          <div>
            <p class="text-gray-600">Transaction ID</p>
            <p class="font-medium font-mono" id="success-transaction-id"></p>
          </div>
          <div>
            <p class="text-gray-600">Amount Paid</p>
            <p class="font-medium">¬£<span id="success-amount"></span></p>
          </div>
          <div>
            <p class="text-gray-600">Job ID</p>
            <p class="font-medium" id="success-job-id"></p>
          </div>
          <div>
            <p class="text-gray-600">Payment Type</p>
            <p class="font-medium" id="success-payment-type"></p>
          </div>
        </div>
      </div>
      <button onclick="window.location.reload()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-md transition-colors">
        Make Another Payment
      </button>
    </div>
  </div>

  <script>
    // Get job ID and hash from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const jobId = urlParams.get('jobId') || urlParams.get('job');
    const hash = urlParams.get('hash');
    
    // Elements
    const loadingEl = document.getElementById('loading');
    const securityRedirectEl = document.getElementById('security-redirect');
    const errorEl = document.getElementById('error');
    const errorMessageEl = document.getElementById('error-message');
    const paymentInterfaceEl = document.getElementById('payment-interface');
    const successEl = document.getElementById('success');
    
    // Payment form elements
    const payButton = document.getElementById('pay-button');
    const payButtonText = document.getElementById('pay-button-text');
    const payButtonLoading = document.getElementById('pay-button-loading');
    const paymentTotal = document.getElementById('payment-total');
    const paymentTotalSection = document.getElementById('payment-total-section');
    const paymentDescription = document.getElementById('payment-description');
    
    // Global variables
    let jobData = null;
    let selectedPayments = [];
    
    // Initialize the payment page
    async function init() {
      // Check if we're returning from a successful payment
      if (urlParams.get('success') === 'true' || urlParams.get('session_id')) {
        handlePaymentSuccess();
        return;
      }
      
      // Check if we have a job ID
      if (!jobId) {
        showError('No job ID provided. Please check your payment link and try again.');
        return;
      }
      
      try {
        // If we don't have a hash, we need to get one
        if (!hash) {
          console.log('No hash provided, getting secure hash...');
          await getSecureHash();
          return;
        }
        
        // Fetch job details with hash
        const response = await fetch(`/.netlify/functions/get-job-details-v2?jobId=${jobId}&hash=${hash}`);
        
        if (!response.ok) {
          if (response.status === 403) {
            throw new Error('Invalid or tampered payment link. Please use the original link provided.');
          }
          throw new Error('Failed to load job details');
        }
        
        jobData = await response.json();
        
        if (!jobData.success) {
          throw new Error(jobData.error || 'Failed to load job details');
        }
        
        // Populate the interface
        populateJobDetails();
        populateFinancialSummary();
        populatePaymentOptions();
        
        // Show the payment interface
        loadingEl.classList.add('hidden');
        paymentInterfaceEl.classList.remove('hidden');
        
      } catch (error) {
        console.error('Error loading job details:', error);
        showError(error.message || 'Failed to load job details');
      }
    }
    
    // Get secure hash and redirect
    async function getSecureHash() {
      try {
        // Show security redirect message
        loadingEl.classList.add('hidden');
        securityRedirectEl.classList.remove('hidden');
        
        // Call API to get hash
        const response = await fetch(`/.netlify/functions/get-job-details-v2?jobId=${jobId}`);
        
        if (!response.ok) {
          throw new Error('Failed to create secure link');
        }
        
        const result = await response.json();
        
        if (!result.success || !result.hash) {
          throw new Error('Failed to generate secure hash');
        }
        
        // Redirect to the secure URL
        const secureUrl = `${window.location.pathname}?jobId=${jobId}&hash=${result.hash}`;
        window.location.href = secureUrl;
        
      } catch (error) {
        console.error('Error getting secure hash:', error);
        securityRedirectEl.classList.add('hidden');
        showError('Failed to create secure connection. Please try again.');
      }
    }
    
    // Populate job details
    function populateJobDetails() {
      document.getElementById('job-id').textContent = jobData.jobId;
      document.getElementById('customer-name').textContent = jobData.jobData.customerName;
      document.getElementById('job-status').textContent = jobData.jobData.statusText;
      
      const startDate = new Date(jobData.jobData.startDate);
      const endDate = new Date(jobData.jobData.endDate);
      document.getElementById('hire-period').textContent = 
        `${formatDate(startDate)} to ${formatDate(endDate)} (${jobData.jobData.hireDays} days)`;
    }
    
    // Populate financial summary
    function populateFinancialSummary() {
      document.getElementById('total-value').textContent = formatCurrency(jobData.financial.actualTotalOwed);
      document.getElementById('amount-paid').textContent = formatCurrency(jobData.financial.totalHirePaid);
      document.getElementById('excess-paid').textContent = formatCurrency(jobData.financial.excessPaid);
      
      // Handle balance display - fix the logic
      const remainingBalance = jobData.financial.remainingHireBalance;
      
      if (remainingBalance < -0.01) { // Overpaid by more than 1p
        document.getElementById('remaining-balance-positive').classList.add('hidden');
        document.getElementById('remaining-balance-negative').classList.remove('hidden');
        document.getElementById('overpaid-amount').textContent = formatCurrency(Math.abs(remainingBalance));
      } else { // Zero or positive balance
        document.getElementById('remaining-balance-positive').classList.remove('hidden');
        document.getElementById('remaining-balance-negative').classList.add('hidden');
        document.getElementById('remaining-balance').textContent = formatCurrency(Math.max(0, remainingBalance));
      }
      
      // Populate job references for payment methods
      document.getElementById('bank-job-id').textContent = jobData.jobId;
      document.getElementById('bank-job-id-2').textContent = jobData.jobId;
      document.getElementById('paypal-job-id').textContent = jobData.jobId;
      document.getElementById('paypal-job-id-2').textContent = jobData.jobId;
      
      // Populate payment history
      populatePaymentHistory();
    }
    
    // Populate payment history
    function populatePaymentHistory() {
      const hirePaymentsList = document.getElementById('hire-payments-list');
      const excessPaymentsList = document.getElementById('excess-payments-list');
      const excessSection = document.getElementById('excess-payments-section');
      
      // Clear existing content
      hirePaymentsList.innerHTML = '';
      excessPaymentsList.innerHTML = '';
      
      // Add hire payments
      if (jobData.payments.hireDeposits.length > 0) {
        jobData.payments.hireDeposits.forEach(payment => {
          const paymentDiv = document.createElement('div');
          paymentDiv.className = 'flex justify-between';
          paymentDiv.innerHTML = `
            <span>${formatDate(new Date(payment.date))} - ${payment.bankName || 'Card Payment'}</span>
            <span class="font-medium text-green-600">¬£${formatCurrency(payment.amount)}</span>
          `;
          hirePaymentsList.appendChild(paymentDiv);
        });
      } else {
        hirePaymentsList.innerHTML = '<p class="text-gray-500 italic">No payments recorded yet</p>';
      }
      
      // Add excess payments
      if (jobData.payments.excessDeposits.length > 0) {
        jobData.payments.excessDeposits.forEach(payment => {
          const paymentDiv = document.createElement('div');
          paymentDiv.className = 'flex justify-between';
          paymentDiv.innerHTML = `
            <span>${formatDate(new Date(payment.date))} - ${payment.bankName || 'Card Payment'}</span>
            <span class="font-medium text-green-600">¬£${formatCurrency(payment.amount)}</span>
          `;
          excessPaymentsList.appendChild(paymentDiv);
        });
        excessSection.classList.remove('hidden');
      } else {
        excessSection.classList.add('hidden');
      }
    }
    
    // IMPROVED: Populate payment options with better logic
    function populatePaymentOptions() {
      const optionsContainer = document.getElementById('payment-options');
      optionsContainer.innerHTML = '';
      
      // Calculate remaining amount needed for hire
      const totalHireValue = jobData.financial.actualTotalOwed;
      const alreadyPaid = jobData.financial.totalHirePaid;
      const remainingBalance = Math.max(0, totalHireValue - alreadyPaid);
      const requiredDeposit = jobData.financial.requiredDeposit;
      const depositAlreadyPaid = jobData.financial.depositPaid;
      
      console.log('Payment options logic:', {
        totalHireValue,
        alreadyPaid,
        remainingBalance,
        requiredDeposit,
        depositAlreadyPaid
      });
      
      // IMPROVED: Better payment option logic
      if (remainingBalance > 0) {
        if (depositAlreadyPaid) {
          // Deposit already paid - only show remaining balance option
          optionsContainer.appendChild(createPaymentOption('balance',
            'Pay Remaining Balance',
            `Complete your hire payment (${formatCurrency(remainingBalance)})`,
            remainingBalance,
            'This will complete your hire payment'
          ));
        } else {
          // Deposit not yet paid - show deposit options
          const isFullPaymentRequired = totalHireValue < 400;
          
          if (isFullPaymentRequired) {
            // Jobs under ¬£400 require full payment
            optionsContainer.appendChild(createPaymentOption('deposit',
              'Full Payment Required',
              `Jobs under ¬£400 require full payment (${formatCurrency(remainingBalance)})`,
              remainingBalance,
              'This will complete your hire payment'
            ));
          } else {
            // Show three options: minimum deposit, 50%, or full amount
            const minDeposit = requiredDeposit;
            const halfPayment = Math.round(totalHireValue * 0.5);
            const fullPayment = remainingBalance;
            
            // Minimum deposit option
            optionsContainer.appendChild(createPaymentOption('deposit',
              'Minimum Deposit (25%)',
              `Secure your booking with the minimum deposit (${formatCurrency(minDeposit)})`,
              minDeposit,
              'This will change your booking status to "Booked"'
            ));
            
            // 50% option (if different from minimum and not more than remaining)
            if (halfPayment > minDeposit && halfPayment <= remainingBalance) {
              optionsContainer.appendChild(createPaymentOption('deposit',
                'Half Payment (50%)',
                `Pay half the total amount (${formatCurrency(halfPayment)})`,
                halfPayment,
                'Pay 50% now, remaining balance later'
              ));
            }
            
            // Full payment option
            optionsContainer.appendChild(createPaymentOption('deposit',
              'Full Payment (100%)',
              `Pay the full amount now (${formatCurrency(fullPayment)})`,
              fullPayment,
              'Complete payment - nothing more to pay'
            ));
          }
        }
      }
      
      // Excess option - show if van on hire and not fully paid
      const excessNeeded = Math.max(0, jobData.excess.amount - jobData.financial.excessPaid);
      if (excessNeeded > 0 && jobData.excess.vanOnHire && jobData.excess.showOption) {
        let excessTitle = 'Insurance Excess';
        let excessDescription = '';
        
        // Determine if payment can be made now
        let canPayNow = false;
        if (jobData.excess.method === 'pre-auth') {
          canPayNow = jobData.excess.canPreAuth;
        } else if (jobData.excess.method === 'payment') {
          canPayNow = true; // Regular payments can always be made
        } else {
          canPayNow = false; // Too early or too late cases
        }
        
        // Handle multiple vans in title and description
        if (jobData.excess.vanCount > 1) {
          excessTitle = `Insurance Excess (${jobData.excess.vanCount} vans)`;
        }
        
        if (jobData.excess.method === 'pre-auth') {
          excessDescription = `Pre-authorization (${formatCurrency(excessNeeded)}) - held but not charged unless needed`;
          if (jobData.excess.vanCount > 1) {
            excessDescription += ` for ${jobData.excess.vanCount} vans`;
          }
        } else if (jobData.excess.method === 'too_early') {
          excessTitle += ' (Available Later)';
          excessDescription = `${formatCurrency(excessNeeded)} required. ${jobData.excess.description}`;
        } else if (jobData.excess.method === 'payment') {
          excessDescription = `Insurance excess payment (${formatCurrency(excessNeeded)}) - refundable after hire`;
          if (jobData.excess.vanCount > 1) {
            excessDescription += ` for ${jobData.excess.vanCount} vans`;
          }
        } else {
          excessDescription = `Insurance excess (${formatCurrency(excessNeeded)}) - ${jobData.excess.description}`;
        }
        
        const excessElement = createPaymentOption('excess',
          excessTitle,
          excessDescription,
          excessNeeded,
          jobData.excess.description,
          !canPayNow // disable if can't pay now
        );
        
        // Add alternative payment message for early bookings
        if (jobData.excess.alternativeMessage && !canPayNow) {
          const alternativeDiv = document.createElement('div');
          alternativeDiv.className = 'mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded text-sm';
          alternativeDiv.innerHTML = `
            <strong>Alternative Payment Options:</strong><br>
            ${jobData.excess.alternativeMessage}<br>
            <span class="text-blue-600">Bank Transfer:</span> Use the bank details above<br>
            <span class="text-blue-600">PayPal:</span> Use the PayPal tab above
          `;
          excessElement.appendChild(alternativeDiv);
        }
        
        optionsContainer.appendChild(excessElement);
      }
      
      // If no payment options available
      if (optionsContainer.children.length === 0) {
        optionsContainer.innerHTML = '<p class="text-gray-600 text-center py-8">All payments have been completed for this booking.</p>';
      }
    }
    
    // Create payment option element
    function createPaymentOption(type, title, description, amount, statusMessage, disabled = false) {
      const div = document.createElement('div');
      div.className = `payment-option border-2 border-gray-200 rounded-lg p-4 ${disabled ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer'}`;
      div.innerHTML = `
        <label class="flex items-start ${disabled ? 'cursor-not-allowed' : 'cursor-pointer'}">
          <input type="radio" name="payment-selection" class="mt-1 mr-3" data-type="${type}" data-amount="${amount}" data-status="${statusMessage}" ${disabled ? 'disabled' : ''}>
          <div class="flex-1">
            <h3 class="font-medium text-gray-900">${title}</h3>
            <p class="text-sm text-gray-600 mt-1">${description}</p>
            <p class="text-lg font-semibold ${disabled ? 'text-gray-400' : 'text-blue-600'} mt-2">¬£${formatCurrency(amount)}</p>
          </div>
        </label>
      `;
      
      if (!disabled) {
        // Add click handler only if not disabled
        const radio = div.querySelector('input[type="radio"]');
        div.addEventListener('click', (e) => {
          if (e.target !== radio) {
            radio.checked = true;
          }
          handlePaymentSelection();
        });
        
        radio.addEventListener('change', handlePaymentSelection);
      }
      
      return div;
    }
    
    // Handle payment selection
    function handlePaymentSelection() {
      const radios = document.querySelectorAll('#payment-options input[type="radio"]');
      selectedPayments = [];
      let total = 0;
      let descriptions = [];
      
      radios.forEach(radio => {
        const option = radio.closest('.payment-option');
        if (radio.checked) {
          option.classList.add('selected');
          selectedPayments.push({
            type: radio.dataset.type,
            amount: parseFloat(radio.dataset.amount),
            status: radio.dataset.status
          });
          total += parseFloat(radio.dataset.amount);
          descriptions.push(radio.dataset.status);
        } else {
          option.classList.remove('selected');
        }
      });
      
      // Update UI
      if (selectedPayments.length > 0) {
        paymentTotal.textContent = formatCurrency(total);
        paymentDescription.textContent = descriptions.join('. ');
        paymentTotalSection.classList.remove('hidden');
        payButton.disabled = false;
        payButtonText.textContent = `Pay ¬£${formatCurrency(total)}`;
      } else {
        paymentTotalSection.classList.add('hidden');
        payButton.disabled = true;
        payButtonText.textContent = 'Select Payment Option';
      }
    }
    
    // Handle payment button click
    async function handlePayment() {
      if (selectedPayments.length === 0) return;
      
      // Show loading state
      payButton.disabled = true;
      payButtonText.classList.add('hidden');
      payButtonLoading.classList.remove('hidden');
      
      try {
        // For now, we'll process the first selected payment
        // In future, we could handle multiple payments
        const payment = selectedPayments[0];
        
        console.log('Creating payment session:', {
          jobId: jobId,
          paymentType: payment.type,
          amount: payment.amount,
          successUrl: window.location.href + '&success=true',
          cancelUrl: window.location.href
        });
        
        const response = await fetch('/.netlify/functions/create-stripe-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            jobId: jobId,
            paymentType: payment.type,
            amount: payment.amount,
            successUrl: window.location.href + '&success=true',
            cancelUrl: window.location.href
          })
        });
        
        console.log('Stripe session response status:', response.status);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('Stripe session error response:', errorText);
          
          let errorMessage = 'Failed to create payment session';
          try {
            const error = JSON.parse(errorText);
            errorMessage = error.error || errorMessage;
            if (error.details) {
              errorMessage += ': ' + error.details;
            }
          } catch (e) {
            errorMessage += ': ' + errorText;
          }
          
          throw new Error(errorMessage);
        }
        
        const session = await response.json();
        console.log('Stripe session created:', session);
        
        // Redirect to Stripe
        window.location.href = session.url;
        
      } catch (error) {
        console.error('Payment error:', error);
        alert('Payment failed: ' + error.message);
        
        // Reset button state
        payButton.disabled = false;
        payButtonText.classList.remove('hidden');
        payButtonLoading.classList.add('hidden');
      }
    }
    
    // Handle payment success
    function handlePaymentSuccess() {
      loadingEl.classList.add('hidden');
      successEl.classList.remove('hidden');
      
      // Populate success details
      document.getElementById('success-job-id').textContent = jobId;
      document.getElementById('success-transaction-id').textContent = urlParams.get('session_id') || 'Processing...';
      document.getElementById('success-amount').textContent = urlParams.get('amount') || 'Processing...';
      document.getElementById('success-payment-type').textContent = urlParams.get('type') || 'Payment';
    }
    
    // Show error message
    function showError(message) {
      loadingEl.classList.add('hidden');
      securityRedirectEl.classList.add('hidden');
      errorMessageEl.textContent = message;
      errorEl.classList.remove('hidden');
    }
    
    // Format currency
    function formatCurrency(value) {
      return parseFloat(value).toFixed(2);
    }
    
    // Format date
    function formatDate(date) {
      return date.toLocaleDateString('en-GB', { 
        weekday: 'short', 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
      });
    }
    
    // Add event listener to pay button
    payButton.addEventListener('click', handlePayment);
    
    // Add tab switching functionality
    document.querySelectorAll('.tab-button').forEach(button => {
      button.addEventListener('click', (e) => {
        const tabId = e.target.id.replace('tab-', '');
        switchTab(tabId);
      });
    });
    
    // Add payment history toggle
    document.getElementById('toggle-payment-history').addEventListener('click', togglePaymentHistory);
    
    // Initialize the page
    init();
    
    // Tab switching function
    function switchTab(activeTab) {
      // Update tab buttons
      document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active', 'border-blue-500', 'text-blue-600');
        button.classList.add('border-transparent', 'text-gray-500');
      });
      
      document.getElementById(`tab-${activeTab}`).classList.add('active', 'border-blue-500', 'text-blue-600');
      document.getElementById(`tab-${activeTab}`).classList.remove('border-transparent', 'text-gray-500');
      
      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
      });
      
      document.getElementById(`content-${activeTab}`).classList.remove('hidden');
    }
    
    // Toggle payment history
    function togglePaymentHistory() {
      const historyDiv = document.getElementById('payment-history');
      const arrow = document.getElementById('history-arrow');
      
      if (historyDiv.classList.contains('hidden')) {
        historyDiv.classList.remove('hidden');
        arrow.classList.add('rotate-90');
      } else {
        historyDiv.classList.add('hidden');
        arrow.classList.remove('rotate-90');
      }
    }
  </script>
</body>
</html>
