<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ooosh Tours - Admin Portal</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTUiIGZpbGw9IiNBNzUzOTAiIHN0cm9rZT0iI0E3NTM5MCIgc3Ryb2tlLXdpZHRoPSIyIi8+CjxjaXJjbGUgY3g9IjE2IiBjeT0iMTYiIHI9IjEwIiBmaWxsPSJ3aGl0ZSIvPgo8Y2lyY2xlIGN4PSIxNiIgY3k9IjE2IiByPSIyIiBmaWxsPSIjQTc1MzkwIi8+Cjwvc3ZnPgo=">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading-spinner {
            border: 2px solid #f3f4f6;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal-overlay {
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Authentication Screen -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-bold text-gray-900">Ooosh Tours Admin</h1>
                <p class="text-gray-600 mt-2">Secure access required</p>
            </div>
            
            <div id="auth-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4"></div>
            <div id="rate-limit-warning" class="hidden bg-yellow-50 border border-yellow-200 text-yellow-700 px-4 py-3 rounded mb-4"></div>
            
            <form id="auth-form">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">
                        Admin Password
                    </label>
                    <input type="password" id="password" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <button type="submit" id="auth-submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <span id="auth-button-text">Access Admin Portal</span>
                    <div id="auth-loading" class="loading-spinner mx-auto hidden"></div>
                </button>
            </form>
            
            <div class="mt-4 text-xs text-gray-500 text-center">
                <div class="flex items-center justify-center space-x-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                    <span>Secure connection active</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Admin Interface -->
    <div id="admin-interface" class="hidden min-h-screen bg-gray-50">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Ooosh Tours Admin</h1>
                        <p class="text-sm text-gray-600">Excess Management Portal</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2 text-sm text-gray-600">
                            <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                            <span>Session Active</span>
                        </div>
                        <button id="logout-btn" class="text-red-600 hover:text-red-800 text-sm font-medium">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <!-- Loading State -->
            <div id="loading-state" class="text-center py-12">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-gray-600">Loading job details...</p>
            </div>

            <!-- Error State -->
            <div id="error-state" class="hidden bg-red-50 border border-red-200 rounded-lg p-6">
                <div class="flex items-center">
                    <div class="text-red-500 mr-3">⚠️</div>
                    <div>
                        <h3 class="text-red-800 font-medium">Error Loading Job</h3>
                        <p id="error-message" class="text-red-700 mt-1"></p>
                    </div>
                </div>
            </div>

            <!-- Job Details -->
            <div id="job-details" class="hidden">
                <!-- Job Info Card -->
                <div class="bg-white rounded-lg shadow-sm border mb-6">
                    <div class="px-6 py-4 border-b">
                        <h2 class="text-lg font-semibold text-gray-900">Job Information</h2>
                    </div>
                    <div class="px-6 py-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <label class="text-sm font-medium text-gray-500">Job ID</label>
                                <p id="job-id" class="text-lg font-mono text-gray-900"></p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-500">Client</label>
                                <p id="client-name" class="text-lg text-gray-900"></p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-500">Hire Period</label>
                                <p id="hire-period" class="text-lg text-gray-900"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Excess Status Card -->
                <div class="bg-white rounded-lg shadow-sm border mb-6">
                    <div class="px-6 py-4 border-b">
                        <h2 class="text-lg font-semibold text-gray-900">Excess Status</h2>
                    </div>
                    <div class="px-6 py-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="text-sm font-medium text-gray-500">Current Status</label>
                                <div id="excess-status" class="flex items-center mt-1">
                                    <span id="status-indicator" class="w-3 h-3 rounded-full mr-2"></span>
                                    <span id="status-text" class="text-lg"></span>
                                </div>
                                <p id="status-details" class="text-sm text-gray-600 mt-1"></p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-500">Available Actions</label>
                                <div id="available-actions" class="mt-2 space-y-2"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white rounded-lg shadow-sm border">
                    <div class="px-6 py-4 border-b">
                        <h2 class="text-lg font-semibold text-gray-900">Recent Activity</h2>
                    </div>
                    <div class="px-6 py-4">
                        <div id="activity-log" class="space-y-3">
                            <p class="text-gray-500 italic">No recent activity</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Universal Modal (for both Claims and Refunds) -->
    <div id="universal-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-overlay flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <!-- Modal Header -->
            <div class="px-6 py-4 border-b">
                <h3 id="modal-title" class="text-lg font-semibold text-gray-900"></h3>
                <p id="modal-subtitle" class="text-sm text-gray-600 mt-1"></p>
            </div>

            <!-- Modal Body -->
            <div class="px-6 py-4">
                <div class="mb-4">
                    <div id="modal-info-section" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                        <div class="flex items-start">
                            <div class="text-blue-500 mr-3">ℹ️</div>
                            <div>
                                <h4 id="modal-info-title" class="text-blue-800 font-medium"></h4>
                                <p id="modal-info-details" class="text-blue-700 text-sm mt-1"></p>
                                <p id="modal-info-amount" class="text-blue-700 text-sm"></p>
                            </div>
                        </div>
                    </div>

                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <span id="amount-label">Amount</span> (£)
                    </label>
                    <div class="relative">
                        <span class="absolute left-3 top-2 text-gray-500">£</span>
                        <input type="number" id="modal-amount" 
                               class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="0.00" step="0.01" min="0.01">
                    </div>
                    <p id="amount-help-text" class="text-xs text-gray-500 mt-1"></p>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <span id="reason-label">Reason</span>
                    </label>
                    <select id="modal-reason" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select reason...</option>
                        <option value="all_fine_reimburse_full">All fine, reimburse in full</option>
                        <option value="vehicle_damage">Vehicle damage</option>
                        <option value="late_return">Late return</option>
                        <option value="underfuelling">Underfuelling</option>
                        <option value="additional_charges">Additional charges</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Notes (Optional)
                    </label>
                    <textarea id="modal-notes" rows="3" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="Additional details..."></textarea>
                </div>

                <!-- Confirmation Checkbox -->
                <div class="mb-4">
                    <label class="flex items-start">
                        <input type="checkbox" id="modal-confirmation" class="mt-1 mr-3">
                        <span class="text-sm text-gray-700">
                            I confirm that I want to <strong id="action-verb">process</strong> <strong>£<span id="confirm-amount">0.00</span></strong> 
                            <span id="action-description">from the customer's account</span>. This action cannot be undone.
                        </span>
                    </label>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="px-6 py-4 border-t bg-gray-50 flex justify-end space-x-3">
                <button id="cancel-modal" class="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                    Cancel
                </button>
                <button id="process-modal" disabled class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center">
                    <span id="modal-button-text">Process</span>
                    <div id="modal-loading" class="loading-spinner ml-2 hidden"></div>
                </button>
            </div>
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div id="notification" class="hidden fixed top-4 right-4 max-w-sm bg-white border rounded-lg shadow-lg z-50">
        <div class="p-4">
            <div class="flex items-start">
                <div id="notification-icon" class="mr-3 mt-0.5"></div>
                <div class="flex-1">
                    <h4 id="notification-title" class="font-medium"></h4>
                    <p id="notification-message" class="text-sm text-gray-600 mt-1"></p>
                </div>
                <button id="close-notification" class="ml-3 text-gray-400 hover:text-gray-600">
                    ✕
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentSession = null;
        let jobData = null;
        let currentJobId = null;
        let currentModalType = null; // 'claim' or 'refund'
        let currentModalData = null;

        // Extract job ID from URL
        function getJobIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('job');
        }

        // Show notification
        function showNotification(type, title, message) {
            const notification = document.getElementById('notification');
            const icon = document.getElementById('notification-icon');
            const titleEl = document.getElementById('notification-title');
            const messageEl = document.getElementById('notification-message');

            if (type === 'success') {
                icon.textContent = '✅';
                titleEl.className = 'font-medium text-green-800';
                notification.className = 'fixed top-4 right-4 max-w-sm bg-green-50 border border-green-200 rounded-lg shadow-lg z-50';
            } else if (type === 'error') {
                icon.textContent = '❌';
                titleEl.className = 'font-medium text-red-800';
                notification.className = 'fixed top-4 right-4 max-w-sm bg-red-50 border border-red-200 rounded-lg shadow-lg z-50';
            } else {
                icon.textContent = 'ℹ️';
                titleEl.className = 'font-medium text-blue-800';
                notification.className = 'fixed top-4 right-4 max-w-sm bg-blue-50 border border-blue-200 rounded-lg shadow-lg z-50';
            }

            titleEl.textContent = title;
            messageEl.textContent = message;
            notification.classList.remove('hidden');

            // Auto-hide after 5 seconds
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 5000);
        }

        // Close notification
        document.getElementById('close-notification').addEventListener('click', () => {
            document.getElementById('notification').classList.add('hidden');
        });

        // Session management
        function saveSession(token) {
            const sessionData = {
                token: token,
                timestamp: Date.now(),
                jobId: currentJobId
            };
            localStorage.setItem('adminSession', JSON.stringify(sessionData));
            currentSession = sessionData;
            
            // Notify other tabs
            localStorage.setItem('adminSessionUpdate', Date.now().toString());
        }

        function loadSession() {
            try {
                const saved = localStorage.getItem('adminSession');
                if (!saved) return null;
                
                const session = JSON.parse(saved);
                const fourHours = 4 * 60 * 60 * 1000;
                
                if (Date.now() - session.timestamp > fourHours) {
                    clearSession();
                    return null;
                }
                
                return session;
            } catch (e) {
                clearSession();
                return null;
            }
        }

        function clearSession() {
            localStorage.removeItem('adminSession');
            localStorage.setItem('adminSessionUpdate', Date.now().toString());
            currentSession = null;
        }

        // Listen for session updates from other tabs
        window.addEventListener('storage', (e) => {
            if (e.key === 'adminSessionUpdate') {
                const session = loadSession();
                if (!session && currentSession) {
                    // Session cleared in another tab
                    showAuthScreen();
                } else if (session && !currentSession) {
                    // Session created in another tab
                    currentSession = session;
                    if (session.jobId === currentJobId) {
                        showAdminInterface();
                    }
                }
            }
        });

        // Authentication
        async function authenticate(password) {
            const response = await fetch('/.netlify/functions/admin-auth', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password, jobId: currentJobId })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Authentication failed');
            }

            const data = await response.json();
            return data.token;
        }

        // Load job details
        async function loadJobDetails() {
            if (!currentSession) {
                throw new Error('No valid session');
            }

            const response = await fetch(`/.netlify/functions/get-admin-details?jobId=${currentJobId}`, {
                headers: {
                    'Authorization': `Bearer ${currentSession.token}`
                }
            });

            if (!response.ok) {
                if (response.status === 401) {
                    clearSession();
                    showAuthScreen();
                    throw new Error('Session expired');
                }
                const error = await response.json();
                throw new Error(error.error || 'Failed to load job details');
            }

            return await response.json();
        }

        // Display job information
        function displayJobDetails(data) {
            jobData = data;
            console.log('📋 Admin data received:', data);

            // Basic job info
            document.getElementById('job-id').textContent = data.jobId;
            document.getElementById('client-name').textContent = data.jobData?.customerName || 'N/A';
            
            // Format hire period
            if (data.jobData?.startDate && data.jobData?.endDate) {
                const startDate = new Date(data.jobData.startDate).toLocaleDateString('en-GB');
                const endDate = new Date(data.jobData.endDate).toLocaleDateString('en-GB');
                document.getElementById('hire-period').textContent = `${startDate} - ${endDate}`;
            } else {
                document.getElementById('hire-period').textContent = 'N/A';
            }

            // Excess status analysis
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            const statusDetails = document.getElementById('status-details');

            // 🔧 FIXED: Read from correct data structure and use NET amounts
            const mondayData = data.mondayIntegration;
            const hasPreAuth = mondayData?.found && 
                              (mondayData.excessStatus === 'Pre-auth taken' && mondayData.preAuthDetails);
            const hasPayments = (data.financial?.excessPaid || 0) > 0; // 🔧 FIXED: Use net amount, not count
            
            console.log('📋 Excess analysis:', {
                mondayFound: mondayData?.found,
                excessStatus: mondayData?.excessStatus,
                hasStripeLink: mondayData?.hasStripeLink,
                hasPayments: hasPayments,
                preAuthDetails: mondayData?.preAuthDetails,
                hasPreAuth: hasPreAuth
            });

            if (hasPreAuth) {
                statusIndicator.className = 'w-3 h-3 rounded-full mr-2 bg-orange-500';
                statusText.textContent = 'Pre-Authorisation Available';
                
                // 🔧 FIXED: Calculate remaining claimable amount
                const originalAmount = mondayData.preAuthDetails?.amount || 1200;
                const alreadyClaimed = data.financial?.excessPaid || 0;
                const remainingClaimable = Math.max(0, originalAmount - alreadyClaimed);
                
                if (remainingClaimable > 0) {
                    statusDetails.textContent = `Setup Intent detected - £${remainingClaimable.toFixed(2)} remaining claimable`;
                } else {
                    statusDetails.textContent = `Pre-auth fully claimed (£${originalAmount.toFixed(2)} total)`;
                }
            } else if (hasPayments) {
                statusIndicator.className = 'w-3 h-3 rounded-full mr-2 bg-blue-500';
                statusText.textContent = 'Payment Available for Refund';
                const netAmount = data.financial?.excessPaid || 0;
                statusDetails.textContent = `£${netAmount} available for refund`; // 🔧 FIXED: Show net amount
            } else {
                statusIndicator.className = 'w-3 h-3 rounded-full mr-2 bg-gray-500';
                statusText.textContent = 'No Actions Available';
                statusDetails.textContent = 'No excess payments or pre-auths detected';
            }

            // Available actions based on actual data
            displayAvailableActions({ hasPreAuth, hasPayments, mondayData, paymentsData: data.payments, jobData: data });
        }

        // Display available actions
        function displayAvailableActions(analysisData) {
            const actionsContainer = document.getElementById('available-actions');
            actionsContainer.innerHTML = '';

            console.log('📋 Displaying actions for:', analysisData);

            if (analysisData.hasPreAuth) {
                console.log('✅ Creating pre-auth claim button');
                
                // 🔧 FIXED: Calculate remaining claimable amount for button
                const originalAmount = analysisData.mondayData?.preAuthDetails?.amount || 1200;
                const alreadyClaimed = analysisData.jobData?.financial?.excessPaid || 0;
                const remainingClaimable = Math.max(0, originalAmount - alreadyClaimed);
                
                if (remainingClaimable > 0) {
                    const claimButton = document.createElement('button');
                    claimButton.className = 'bg-orange-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-orange-700';
                    claimButton.textContent = `Claim Pre-Auth (£${remainingClaimable.toFixed(2)} available)`;
                    claimButton.addEventListener('click', () => {
                        console.log('🔐 Opening claim modal');
                        openUniversalModal('claim', analysisData);
                    });
                    actionsContainer.appendChild(claimButton);
                } else {
                    // Pre-auth fully claimed
                    const fullyClaimedDiv = document.createElement('div');
                    fullyClaimedDiv.className = 'text-gray-500 text-sm italic';
                    fullyClaimedDiv.textContent = `Pre-auth fully claimed (£${originalAmount.toFixed(2)} total)`;
                    actionsContainer.appendChild(fullyClaimedDiv);
                }
            }

            if (analysisData.hasPayments) {
                console.log('✅ Creating refund button');
                const refundButton = document.createElement('button');
                refundButton.className = 'bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-700 ml-2';
                refundButton.textContent = 'Process Refund';
                refundButton.addEventListener('click', () => {
                    console.log('💸 Opening refund modal');
                    openUniversalModal('refund', analysisData);
                });
                actionsContainer.appendChild(refundButton);
            }

            if (!analysisData.hasPreAuth && !analysisData.hasPayments) {
                console.log('📋 No actions available');
                const noActions = document.createElement('p');
                noActions.className = 'text-gray-500 text-sm italic';
                noActions.textContent = 'No actions available';
                actionsContainer.appendChild(noActions);
            }
        }

        // Open universal modal for both claims and refunds
        function openUniversalModal(type, analysisData) {
            console.log(`🔧 Opening ${type} modal with data:`, analysisData);
            
            currentModalType = type;
            currentModalData = analysisData;
            
            const modal = document.getElementById('universal-modal');
            const title = document.getElementById('modal-title');
            const subtitle = document.getElementById('modal-subtitle');
            const infoTitle = document.getElementById('modal-info-title');
            const infoDetails = document.getElementById('modal-info-details');
            const infoAmount = document.getElementById('modal-info-amount');
            const amountLabel = document.getElementById('amount-label');
            const amountHelpText = document.getElementById('amount-help-text');
            const reasonLabel = document.getElementById('reason-label');
            const actionVerb = document.getElementById('action-verb');
            const actionDescription = document.getElementById('action-description');
            const modalButtonText = document.getElementById('modal-button-text');
            const amountInput = document.getElementById('modal-amount');

            if (type === 'claim') {
                // Configure for pre-auth claiming
                title.textContent = 'Claim Pre-Authorisation';
                subtitle.textContent = 'Convert pre-auth to actual charge';
                
                const preAuthData = analysisData.mondayData?.preAuthDetails;
                const setupIntentId = preAuthData?.setupIntentId;
                const originalAmount = preAuthData?.amount || 1200;
                
                // 🔧 FIXED: Calculate remaining claimable amount for modal
                const alreadyClaimed = analysisData.jobData?.financial?.excessPaid || 0;
                const maxAmount = Math.max(0, originalAmount - alreadyClaimed);

                infoTitle.textContent = 'Pre-Authorisation Available';
                infoDetails.textContent = `Setup Intent ID: ${setupIntentId || 'Extracting...'}`;
                
                if (maxAmount > 0) {
                    infoAmount.textContent = `Remaining claimable: £${maxAmount.toFixed(2)} (of £${originalAmount.toFixed(2)} total)`;
                } else {
                    infoAmount.textContent = `Fully claimed (£${originalAmount.toFixed(2)} total)`;
                }
                
                amountLabel.textContent = 'Amount to Claim';
                amountHelpText.textContent = `Enter the amount to charge from the pre-authorisation (max £${maxAmount.toFixed(2)})`;
                reasonLabel.textContent = 'Reason for Claim';
                actionVerb.textContent = 'claim';
                actionDescription.textContent = 'from the customer\'s pre-authorisation';
                modalButtonText.textContent = 'Process Claim';
                
                amountInput.max = maxAmount;
                amountInput.value = '';
                
                // Store the setup intent ID for later use
                modal.dataset.setupIntentId = setupIntentId;
                modal.dataset.maxAmount = maxAmount;
                
            } else if (type === 'refund') {
                // Configure for refund processing
                title.textContent = 'Process Refund';
                subtitle.textContent = 'Refund excess payment to customer';
                
                const totalPaid = analysisData.jobData?.financial?.excessPaid || 0;
                const payments = analysisData.paymentsData?.excessDeposits || [];

                infoTitle.textContent = 'Excess Payment Available for Refund';
                infoDetails.textContent = `${payments.length} excess payment(s) found`;
                infoAmount.textContent = `Total paid: £${totalPaid.toFixed(2)}`;
                
                amountLabel.textContent = 'Amount to Refund';
                amountHelpText.textContent = 'Enter the amount to refund to the customer';
                reasonLabel.textContent = 'Reason for Refund';
                actionVerb.textContent = 'refund';
                actionDescription.textContent = 'to the customer\'s account';
                modalButtonText.textContent = 'Process Refund';
                
                amountInput.max = totalPaid;
                amountInput.value = '';
                
                // Store payment data for later use
                modal.dataset.totalPaid = totalPaid;
                modal.dataset.paymentsData = JSON.stringify(payments);
            }
            
            // Reset form
            document.getElementById('modal-reason').value = '';
            document.getElementById('modal-notes').value = '';
            document.getElementById('modal-confirmation').checked = false;
            document.getElementById('process-modal').disabled = true;
            document.getElementById('confirm-amount').textContent = '0.00';

            modal.classList.remove('hidden');
        }

        // Amount input handler
        document.getElementById('modal-amount').addEventListener('input', function() {
            const amount = parseFloat(this.value) || 0;
            const confirmAmount = document.getElementById('confirm-amount');
            const processButton = document.getElementById('process-modal');
            const confirmation = document.getElementById('modal-confirmation');

            confirmAmount.textContent = amount.toFixed(2);
            
            // Enable/disable process button
            updateModalButton();
        });

        // Reason and confirmation handlers
        document.getElementById('modal-reason').addEventListener('change', function() {
            updateModalButton();
        });

        document.getElementById('modal-confirmation').addEventListener('change', function() {
            updateModalButton();
        });

        function updateModalButton() {
            const amount = parseFloat(document.getElementById('modal-amount').value) || 0;
            const hasReason = document.getElementById('modal-reason').value;
            const isConfirmed = document.getElementById('modal-confirmation').checked;
            
            document.getElementById('process-modal').disabled = !(amount > 0 && hasReason && isConfirmed);
        }

        // Process modal action (claim or refund)
        async function processModalAction() {
            const amount = parseFloat(document.getElementById('modal-amount').value);
            const reason = document.getElementById('modal-reason').value;
            const notes = document.getElementById('modal-notes').value;
            const modal = document.getElementById('universal-modal');

            console.log(`🔧 Processing ${currentModalType}:`, { amount, reason, notes });

            if (!amount || !reason) {
                showNotification('error', 'Validation Error', 'Please fill in all required fields');
                return;
            }

            // Show loading state
            const button = document.getElementById('process-modal');
            const buttonText = document.getElementById('modal-button-text');
            const loading = document.getElementById('modal-loading');
            
            button.disabled = true;
            buttonText.textContent = 'Processing...';
            loading.classList.remove('hidden');

            try {
                let endpoint, requestData;
                
                if (currentModalType === 'claim') {
                    const setupIntentId = modal.dataset.setupIntentId;
                    
                    if (!setupIntentId) {
                        throw new Error('Could not find setup intent ID for this pre-authorization');
                    }
                    
                    endpoint = '/.netlify/functions/admin-claim-preauth';
                    requestData = {
                        jobId: currentJobId,
                        amount: amount,
                        reason: reason,
                        notes: notes,
                        setupIntentId: setupIntentId
                    };
                    
                } else if (currentModalType === 'refund') {
                    const paymentsData = JSON.parse(modal.dataset.paymentsData || '[]');
                    const latestPayment = paymentsData[0]; // Get most recent payment
                    
                    endpoint = '/.netlify/functions/admin-refund-payment';
                    requestData = {
                        jobId: currentJobId,
                        amount: amount,
                        reason: reason,
                        notes: notes,
                        paymentId: latestPayment?.stripePaymentId || null, // May be null for manual payments
                        depositId: latestPayment?.id || null
                    };
                }

                console.log(`📤 Sending ${currentModalType} request to backend...`);
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentSession.token}`
                    },
                    body: JSON.stringify(requestData)
                });

                console.log(`📥 ${currentModalType} response status:`, response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`❌ ${currentModalType} request failed:`, errorText);
                    
                    let errorMessage = `Failed to process ${currentModalType}`;
                    try {
                        const error = JSON.parse(errorText);
                        errorMessage = error.error || errorMessage;
                        if (error.details) {
                            errorMessage += ': ' + error.details;
                        }
                    } catch (e) {
                        errorMessage += ': ' + errorText;
                    }
                    
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                console.log(`✅ ${currentModalType} successful:`, result);
                
                // Close modal and show success
                modal.classList.add('hidden');
                showNotification('success', `${currentModalType === 'claim' ? 'Claim' : 'Refund'} Processed`, 
                    `Successfully ${currentModalType === 'claim' ? 'claimed' : 'refunded'} £${amount.toFixed(2)}`);
                
                // Reload job details
                await refreshJobDetails();

            } catch (error) {
                console.error(`❌ ${currentModalType} error:`, error);
                showNotification('error', `${currentModalType === 'claim' ? 'Claim' : 'Refund'} Failed`, error.message);
            } finally {
                // Reset button state
                button.disabled = false;
                buttonText.textContent = currentModalType === 'claim' ? 'Process Claim' : 'Process Refund';
                loading.classList.add('hidden');
            }
        }

        // Cancel modal
        function cancelModal() {
            document.getElementById('universal-modal').classList.add('hidden');
            currentModalType = null;
            currentModalData = null;
        }

        // Refresh job details
        async function refreshJobDetails() {
            try {
                document.getElementById('loading-state').classList.remove('hidden');
                document.getElementById('job-details').classList.add('hidden');
                document.getElementById('error-state').classList.add('hidden');

                const data = await loadJobDetails();
                displayJobDetails(data);

                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('job-details').classList.remove('hidden');
            } catch (error) {
                console.error('Error refreshing job details:', error);
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('error-state').classList.remove('hidden');
                document.getElementById('error-message').textContent = error.message;
            }
        }

        // UI management
        function showAuthScreen() {
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('admin-interface').classList.add('hidden');
            document.getElementById('password').focus();
        }

        function showAdminInterface() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('admin-interface').classList.remove('hidden');
            loadJobData();
        }

        async function loadJobData() {
            try {
                const data = await loadJobDetails();
                displayJobDetails(data);

                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('job-details').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading job details:', error);
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('error-state').classList.remove('hidden');
                document.getElementById('error-message').textContent = error.message;
            }
        }

        // Event listeners
        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const password = document.getElementById('password').value;
            const submitButton = document.getElementById('auth-submit');
            const buttonText = document.getElementById('auth-button-text');
            const loading = document.getElementById('auth-loading');
            const errorDiv = document.getElementById('auth-error');

            // Clear previous errors
            errorDiv.classList.add('hidden');

            // Show loading state
            submitButton.disabled = true;
            buttonText.classList.add('hidden');
            loading.classList.remove('hidden');

            try {
                const token = await authenticate(password);
                saveSession(token);
                showAdminInterface();
            } catch (error) {
                console.error('Authentication error:', error);
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
                
                // Show rate limit warning if applicable
                if (error.message.includes('rate limit') || error.message.includes('locked out')) {
                    document.getElementById('rate-limit-warning').classList.remove('hidden');
                }
            } finally {
                // Reset button state
                submitButton.disabled = false;
                buttonText.classList.remove('hidden');
                loading.classList.add('hidden');
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            clearSession();
            showAuthScreen();
        });

        document.getElementById('cancel-modal').addEventListener('click', cancelModal);
        document.getElementById('process-modal').addEventListener('click', processModalAction);

        // Initialize
        currentJobId = getJobIdFromUrl();
        if (!currentJobId) {
            document.getElementById('error-state').classList.remove('hidden');
            document.getElementById('error-message').textContent = 'No job ID specified in URL';
            document.getElementById('loading-state').classList.add('hidden');
        } else {
            // Check for existing session
            const existingSession = loadSession();
            if (existingSession && existingSession.jobId === currentJobId) {
                currentSession = existingSession;
                showAdminInterface();
            } else {
                showAuthScreen();
            }
        }
    </script>
</body>
</html>
